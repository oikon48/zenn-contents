---
title: "Claude Codeのコンテキストウィンドウを深く理解する：トークン使用量とカテゴリ内訳の詳細解説"
emoji: "🧠"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [claudecode, claude, ai, token]
published: false
---

## はじめに

Claude Codeを使用している際、画面の右上に表示されるコンテキストウィンドウは、AIとの対話において非常に重要な情報を提供しています。このウィンドウでは、現在のトークン使用状況やメモリの使用量、接続されているツールの情報などが詳細に表示されます。

本記事では、CLIの「/context」表示（バージョン 1.0.86 の出力仕様に準拠）を基に、コンテキストウィンドウの各要素について詳しく解説し、効率的なClaude Codeの使い方を身につけていきましょう。

### 対象バージョンと表示方法

- 対象: Claude Code CLI v1.0.86（`@anthropic-ai/claude-code/cli.js`）
- 表示方法: 対話モードで`/context`を入力
- 備考: バージョンによっては`/status`にコンテキスト使用状況が含まれます

## コンテキストウィンドウの概要表示

### モデル情報とトークン使用状況

コンテキストウィンドウの最上部には、以下の基本情報が表示されます：

- **モデル名**: 現在使用中のClaude モデル（例：Claude Sonnet 4）
- **使用トークン数/最大トークン数**: 現在の使用量と上限
- **使用率（%）**: コンテキストウィンドウの使用割合

この情報により、現在どの程度のコンテキストを消費しているか、残りどの程度使用できるかを一目で把握できます。

### 表示ロジックの要点

- トークン数が0のカテゴリは非表示
- Free spaceは残容量がある場合のみ表示
- 「System tools」は状況により「System prompt」の代替として現れることがある
- 一覧（Memory files / MCP tools / Custom agents）は、該当データがある場合のみ表示

## カテゴリ内訳の詳細解説

コンテキストウィンドウでは、トークン使用量を以下のカテゴリに分けて表示します（トークン数が0より大きいもののみ表示）。各カテゴリはCLI実装（v1.0.86）の集計ロジックに準拠しています：

### System prompt

システムレベルのプロンプトと補助的なシステムメッセージ由来のトークンです。ユーザーは直接編集できませんが、環境やフラグにより量が変動します。

- 含まれるもの: エージェントの基本行動ルール; セーフティ/セキュリティの制約; 出力スタイル・フォーマット指示; ファイルやシェル実行時のガードレール; CLIセッション管理の補助文言
- 含まれないもの: ユーザーの発話; ツール定義メタデータ; ツール実行時の入出力; メモリファイル本文
- 表示条件: トークン>0。環境により「System tools」が代替表示される場合あり（どちらか一方）
- 増える要因: 企業ポリシーやフラグに基づく追加指示; 出力規約の厳密化や手順追加; 内部ガイダンスの拡張

### System tools と MCP tools

#### System tools
Claude Codeに組み込まれているビルトインツールの定義情報（名前、説明、引数・戻り値のJSON Schema、失敗時のエラー構造など）由来のトークンです。実装上、環境や初期化手順により、このカテゴリが「System prompt」の代替として表示されることがあります。

- 含まれるもの: `bash`の説明・引数定義; `read_file`/`write_file`/`edit_file`のスキーマ; `glob`/`rg`のパラメータ仕様; `todo_write`の入出力; `web.fetch`/`web.search`の引数・レスポンス定義
- 含まれないもの: 実行時の標準出力やエラー; 取得したHTTP本文や検索結果; ファイル本文や差分（それらは「Tool use & results」）
- 表示条件: トークン>0。System promptと排他的に表示される場合あり
- 増える要因: ビルトインツールの追加; 既存ツールのスキーマ肥大（深いネスト・複数の`oneOf/anyOf`・大量の`enum`や例示）

#### MCP tools
Model Context Protocol経由で接続されている外部ツールの「定義情報（メタデータ）」由来のトークンです。CLIは各MCPサーバーから取得したツール一覧の名前・説明・入出力スキーマをコンテキストに組み込み、合計トークンを集計します。

例えば：
- **Obsidian MCP Tools**: セマンティック検索、テンプレート、ファイル管理機能（バージョン0.2.27）
- **Puppeteer**: ブラウザ自動化
- **GitHub**: リポジトリ操作
- その他のカスタムMCPサーバー

- 含まれるもの: サーバー単位の`tools`定義; 各ツールの`name`/`description`; `inputSchema`と`resultSchema`のJSON Schema; サーバー名（serverName）と紐づけ情報
- 含まれないもの: MCPツール実行時の引数や結果本文; 外部サービスから返るレスポンス本文; 実行ログ（それらは「Tool use & results」）
- 表示条件: トークン>0。サーバー数・各サーバーのツール数・各スキーマの複雑さに比例
- 増える要因: サーバー追加; スキーマの深いネスト・`allOf/oneOf/anyOf`・大きな`enum`配列・長い説明や注釈

### Tool use & results

ツールの実行履歴（要求と結果）由来のトークンです。CLIは各ツール呼び出しで渡した引数（リクエスト）と返却された本文（レスポンス、標準出力、エラー出力など）をコンテキストに残し、その合計を集計します。

- 含まれるもの: ツール呼び出し要求（コマンド・引数・オプションの文字列化）; 実行結果（標準出力/標準エラーの本文）; `read_file`や`rg`で表示したファイル本文・検索結果; `web.fetch`のレスポンス本文の抜粋; エラー発生時のメッセージやスタック
- 含まれないもの: ツールのスキーマ定義; メモリ本文; 通常の会話メッセージ
- 表示条件: トークン>0（ツール未使用なら非表示）
- 増える要因: 大きいファイルの全量表示; 冗長な`rg`結果の貼り付け; HTTPレスポンスの長文本文; 同じ出力の繰り返し貼付
- 最適化: 結果の要約・一部のみ表示・ページング; 不要な再掲を避ける; 長大なログは外部ファイル参照に切替

### Memory files

Claude Codeのメモリ機能で読み込まれるファイル本文の合算トークンです。CLIはプロジェクトやユーザーのメモリ定義から該当ファイルを解決し、インポート規則に従って本文を取り込みます。

1. **Enterprise Policy**: システム全体の指示
2. **Project Memory**: チーム共有のプロジェクト指示  
3. **User Memory**: 個人設定（全プロジェクト共通）
4. **（非推奨）Project Local Memory**: プロジェクト固有の旧形式

含まれるものの詳細: `CLAUDE.md`や`memory/*.md`の本文; `@path/to/import`指定の解決（最大5階層の再帰）; Enterprise/Project/User/Local 各層の有効なメモリエントリ

含まれないもの: ツール定義メタ; ツール実行結果; 通常の会話メッセージ; 参照のみで未読込の外部リンク

その他: 表示条件はトークン>0; 増える要因は長文ドキュメントの格納・インポート数増・重複含有; 管理は`/memory`で閲覧・有効/無効・クリア

### Custom agents

カスタムエージェントの定義情報です。以下のソース分類で表示されます：

- **Project**: プロジェクト固有の設定
- **User**: ユーザー個人の設定  
- **Local**: ローカル環境の設定
- **Built-in**: 組み込みエージェント
- **Flag**: 機能フラグベースの設定
- **Policy**: ポリシーベースの制約
- **Plugin**: プラグイン由来の拡張機能

カスタムエージェントの「定義テキスト」や関連メタ情報のトークンです。CLIはエージェントのソース（Project/User/Local/Flag/Policy/Plugin/Built-in）ごとに収集した定義をコンテキストに含め、合計トークンを集計します。

- 含まれるもの: エージェントの役割/スコープの説明; 実行方針や禁止事項; 使役するツール名などの宣言文; 定義ブロックに付随するメタ文字列
- 含まれないもの: ランタイムのツール入出力; 会話本文; メモリ本文
- 表示条件: トークン>0。ソースは整形（Project/User/Local/Flag/Policy/Plugin/Built-in）して表示
- 増える要因: 複数エージェント同時有効化; 一体あたりのプロンプト定義の長文化; 追加の方針・注釈

### Messages

実際の会話メッセージ（user、assistant、その他）のトークン使用量です。対話が長くなるほど増加し、通常はコンテキストの大部分を占めます。以下の要素が含まれます：

- **ユーザーメッセージ**: 質問や指示
- **アシスタント応答**: Claude Codeの回答や説明  
- **システムメッセージ**: 内部処理に関する情報
- **フィードバックメッセージ**: エラーや警告

過去の会話履歴（user/assistant/その他のメッセージ）に由来するトークンです。CLIは直近の対話メッセージをコンテキストとして保持し、その合計を集計します。

- 含まれるもの: ユーザーの指示/質問; アシスタントの応答; 運用上挿入される短い案内文や注記
- 含まれないもの: ツール定義・スキーマ; ツール実行入出力本文; メモリ本文
- 表示条件: トークン>0。長いやり取りや大きなコードブロックで急増
- 増える要因: コードやログの貼付; 複数回の長文往復; 逐次的な詳細説明
- 最適化: 要点のみ保持; 大きな貼付はツール参照に移す; セッションを適宜分割

### Free space

残りの利用可能なトークン枠です。この値が0に近づくと、新しい情報を追加するのが困難になります。一般的に：

- **50%以上**: 十分な余裕あり
- **20-50%**: 通常使用範囲
- **20%未満**: 注意が必要、新しいセッション開始を検討
- **5%未満**: 緊急、すぐにセッションの整理が必要

なお、Free spaceは残容量が0より大きい場合のみ表示されます。

実装上の注意: 表示条件は残余トークン>0; 0以下では非表示; 算出は各カテゴリの合算とモデル上限の差分; 変動要因はモデル切替・会話/ツール結果/メモリ・ツール定義の増減

## 管理画面の活用

### 各種一覧表示

コンテキストウィンドウでは、以下の詳細情報も確認できます：

#### メモリファイル一覧
- **表示列**: type, path, tokens
- **管理**: `/memory`コマンドで詳細操作

#### MCPツール一覧
- **表示列**: name, serverName, tokens  
- **管理**: `/mcp`コマンドで詳細操作

#### カスタムエージェント一覧
- **表示列**: agentType, source, tokens
- **管理**: `/agents`コマンドで詳細操作

これらの情報により、どのコンポーネントがどの程度のトークンを消費しているかを把握し、必要に応じて最適化を行えます。

## ビジュアルグリッドの読み方

コンテキストウィンドウの下部には、トークン使用状況を視覚的に表現するグリッドが表示されます：

- **サイズ**: 10×10または10×20程度のブロック
- **表現**: 「⛁」や「⛀」でカテゴリ別の占有率を表示
- **空き容量**: 「⛶」でFree spaceを表示

このビジュアルグリッドにより、各カテゴリの相対的な使用量を直感的に理解できます。

表示はCLIの「/context」出力に準拠しており、グリッドの行列数は環境により10×10または10×20程度で調整されます。

## 実践的な活用法

### トークン使用量の最適化

1. **不要なメモリファイルの削除**: `/memory`コマンドで未使用のファイルを削除
2. **MCPツールの見直し**: 使用していないツールの接続を解除
3. **会話履歴の整理**: 長すぎる対話は新しいセッションで開始

### 効率的なコンテキスト管理

- Free spaceが20%を下回ったら新しいセッションを検討
- 大きなファイル操作後はコンテキスト使用量をチェック
- 定期的にビジュアルグリッドで全体のバランスを確認

### 長時間作業時の戦略

複数時間にわたる作業では：
1. 重要な情報はメモリファイルに保存
2. 段階的にセッションを区切る
3. プロジェクト設定でよく使用するツールを事前定義

## 参考コマンド

- `/memory`: メモリファイルの確認・管理
- `/mcp`: MCPツールの確認
- `/agents`: カスタムエージェントの確認
- `/status`: 現在のセットアップ状況（バージョンによりコンテキスト使用状況を含む）

## まとめ

Claude Codeのコンテキストウィンドウは、単なる情報表示ではなく、効率的な開発作業のための重要なダッシュボードです。各カテゴリの意味を理解し、適切にトークン使用量を管理することで：

- より長時間の連続作業が可能になる
- 必要な情報を効率的に保持できる
- AIとのやり取りがよりスムーズになる

定期的にコンテキストウィンドウをチェックし、必要に応じて最適化を行うことで、Claude Codeの潜在能力を最大限に活用できるでしょう。

## 参考文献（Anthropic公式）

1. Claude Code: Overview — https://docs.anthropic.com/en/docs/claude-code/overview
2. Claude Code: CLI Usage — https://docs.anthropic.com/ja/docs/claude-code/cli-usage
3. Claude Code: Memory — https://docs.anthropic.com/en/docs/claude-code/memory
4. Claude Code: Sub agents（Custom agents関連） — https://docs.anthropic.com/en/docs/claude-code/sub-agents
5. Claude Code: Settings — https://docs.anthropic.com/ja/docs/claude-code/settings
6. Model Context Protocol: Introduction — https://modelcontextprotocol.io/introduction
7. Models overview（コンテキスト長・トークン上限）— https://docs.anthropic.com/en/docs/about-claude/models/overview#model-comparison-table
